#!/bin/sh

myshell=/bin/tcsh
mygroup=fywss
staffaccount="steve"
keyfile=files/authorized_keys

user=$1

homedir=/home/$user
sshdir=$homedir/.ssh

usage() {
	echo usage: ./bin/setupaccount USER && exit 1
}

if test `whoami` != root; then
	echo must be run as root
	usage
fi

if test -d $homedir; then
	echo user $user already exists but please change the password now
	passwd
else
	echo creating user: $user
	groupadd $mygroup
	adduser --gecos $user --ingroup $mygroup --shell $myshell $user

	if test $user = $staffaccount; then
		# we don't want to do this for regular accounts, such as 'pi'
		usermod -G adm,root,www-data,operator,staff $user
		chfn -f 'Steve Kotsopoulos' $user
		echo "$user ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/011_$user-nopasswd
	fi
fi

if test ! -d $sshdir; then
	echo setting up ssh for $user
	mkdir -p $sshdir
	cp $keyfile $sshdir
	chown -R $user $sshdir
	chmod 600 $sshdir/*
fi
