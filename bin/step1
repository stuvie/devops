#!/bin/sh

staffaccount="steve"
utilities="ansible lshw tcsh lsof tcpdump time locales-all nginx"

startdir=`pwd`
appdir=`basename $startdir`
bakdir=/bak/fresh

usage() {
	echo usage: sudo ./bin/step1 HOSTNAME IP_ADDRESS && exit 1
}

if test `whoami` != root; then
	echo must be run as root
	usage
fi

if test $# -lt 2; then
	usage
fi

myhost=$1
myipaddress=$2

if test -d $bakdir; then
	echo error: $bakdir already exists && exit 2
fi

echo creating $bakdir
mkdir -p $bakdir
cp -a /etc $bakdir
touch /etc/FRESH_INSTALL

if test `uname` = Darwin; then
	./bin/setupaccount $staffaccount
	echo securing sshd:
	cp files/darwin/sshd_config /etc/ssh
	cp files/darwin/rc.local /etc
	cp files/darwin/local.startup.plist /Library/LaunchDaemons
	ln -s /usr/local/servers /
	ln -s /Volumes /n
	touch /etc/LOCAL_changes_start
	exit 0
fi

./bin/hwinfo > hwinfo-$myhost.txt
./bin/setupaccount pi
./bin/setupaccount $staffaccount

if test `systemctl is-enabled ssh`; then
	echo sshd is already enabled
else
	echo enabling sshd:
	sudo systemctl enable ssh
	sudo systemctl start ssh
	sleep 10 # give it time to start up
fi

echo securing sshd:
cp files/sshd_config /etc/ssh
diff -r $bakdir/etc/ssh/sshd_config /etc/ssh
systemctl restart ssh

cp files/hosts /etc
cp files/services /etc
cat files/dhcpcd.conf | sed s/10.0.1.5/$myipaddress/ > /etc/dhcpcd.conf
cp files/resolv.conf /etc
cp files/rc.local /etc
echo $myhost > /etc/hostname
hostname $myhost

echo installing updates and utilities:
set -x
apt-get update
apt-get upgrade -y
apt-get install -y $utilities
cp files/default /etc/nginx/sites-available/default
