#!/bin/sh

staffaccount="steve"
utilities="ansible lshw tcsh lsof tcpdump time locales-all nginx"

startdir=`pwd`
appdir=`basename $startdir`
bakdir=/bak/fresh

usage() {
	echo usage: sudo ./bin/step1 HOSTNAME IP_ADDRESS && exit 1
}

if test `whoami` != root; then
	echo must be run as root
	usage
fi

if test $# -lt 2; then
	usage
fi

myhost=$1
myipaddress=$2

if test -d $bakdir; then
	echo error: $bakdir already exists && exit 2
fi

echo creating $bakdir
mkdir -p $bakdir

if test `uname` = Darwin; then
	if test ! -e /usr/bin/git; then
		echo Please install XCode developer tools first
		exit 0
	fi
	cp -a /private/etc $bakdir
	touch /etc/FRESH_INSTALL
	./bin/setupaccount $staffaccount
	echo securing sshd:
	cp darwin/files/sshd_config /etc/ssh
	cp files/hosts /etc
	chgrp staff /etc/hosts
	chmod 664 /etc/hosts
	cp darwin/files/rc.local /etc
	cp darwin/files/local.startup.plist /Library/LaunchDaemons
	mkdir /usr/local/servers
	chown $staffaccount /usr/local/servers
	ln -s /usr/local/servers /
	ln -s /Volumes /n
	ln -s /usr/local/var/log/nginx /var/log
	ln -s /usr/local/etc/nginx /etc
	ln -s /Users/steve/bin /var/root
	scutil --set HostName $myhost
	scutil --set LocalHostName `echo $myhost | sed 's/\..*//'`
	scutil --set ComputerName $myhost
	dscacheutil -flushcache
	touch /etc/LOCAL_changes_start
	echo getting hardware info
	./bin/hwinfo > $bakdir/hwinfo-$myhost.txt
	system_profiler -detailLevel basic > $bakdir/system-$myhost.txt
	exit 0
fi

cp -a /etc $bakdir
touch /etc/FRESH_INSTALL

./bin/hwinfo > $bakdir/hwinfo-$myhost.txt

if test $myhost = exit; then
	echo quick exit
	exit 0
fi

./bin/setupaccount pi
./bin/setupaccount $staffaccount

if test `systemctl is-enabled ssh`; then
	echo sshd is already enabled
else
	echo enabling sshd:
	sudo systemctl enable ssh
	sudo systemctl start ssh
	sleep 10 # give it time to start up
fi

echo securing sshd:
cp files/sshd_config /etc/ssh
diff -r $bakdir/etc/ssh/sshd_config /etc/ssh
systemctl restart ssh

cp files/hosts /etc
cp files/services /etc
cat files/dhcpcd.conf | sed s/10.0.1.5/$myipaddress/ > /etc/dhcpcd.conf
cp files/resolv.conf /etc
cp files/rc.local /etc
echo $myhost > /etc/hostname
hostname $myhost

echo installing updates and utilities:
set -x
apt-get update
apt-get upgrade -y
apt-get install -y $utilities
cp files/default /etc/nginx/sites-available/default
